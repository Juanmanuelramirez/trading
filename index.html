
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Trading con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Radar de Inversiones con IA</h1>
            <p class="text-gray-400 mt-2 text-lg">Descubre las 10 mejores oportunidades del día basadas en noticias del mercado.</p>
        </header>

        <main class="space-y-8">
            <div class="flex justify-center">
                 <button id="analyze-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                    <svg id="button-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3" />
                    </svg>
                    <span id="button-text">Analizar Mercado Ahora</span>
                </button>
            </div>

            <!-- Columna de Resultados -->
            <div class="space-y-6">
                 <div id="loader" class="hidden flex-col items-center justify-center glass-card rounded-2xl p-6 min-h-[300px]">
                    <div class="loader h-16 w-16 rounded-full border-4 border-gray-700 border-t-blue-500"></div>
                    <p id="loader-text" class="mt-4 text-gray-300 text-lg">Analizando noticias del mercado...</p>
                </div>

                <div id="results-container" class="hidden glass-card rounded-2xl p-6">
                    <h2 class="text-3xl font-semibold mb-4 text-center">Top 10 Oportunidades de Inversión</h2>
                    <div class="table-container">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-sm">
                                <tr>
                                    <th class="p-3">Activo</th>
                                    <th class="p-3">Empresa</th>
                                    <th class="p-3">Sentimiento</th>
                                    <th class="p-3 text-right">Valor Actual (USD)</th>
                                    <th class="p-3 text-right">Rendimiento Estimado (1 mes)</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- Las filas se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>Precios de acciones simulados para demostración.</p>
            <p>Descargo de responsabilidad: Esta es una herramienta de demostración. Las recomendaciones no constituyen asesoramiento financiero.</p>
        </footer>
    </div>

<script>
    // --- DOM Elements ---
    const analyzeButton = document.getElementById('analyze-button');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const resultsContainer = document.getElementById('results-container');
    const resultsTbody = document.getElementById('results-tbody');

    // --- Event Listeners ---
    analyzeButton.addEventListener('click', handleAnalysis);

    // --- Main Logic ---
    async function handleAnalysis() {
        setLoadingState(true, 'Contactando al servidor para obtener noticias...');
        resultsContainer.classList.add('hidden');

        try {
            const articles = await fetchNews();
            if (!articles || articles.length === 0) {
                 console.error("No se encontraron noticias para analizar.");
                 setLoadingState(false);
                 return;
            }

            setLoadingState(true, 'La IA está analizando el mercado... (esto puede tardar un momento)');
            const newsHeadlines = articles.map(a => a.title).join('\n');
            const analysisResults = await callGeminiForBulkAnalysis(newsHeadlines);

            const positiveOpportunities = analysisResults
                .filter(res => res.sentiment === 'Positivo' && res.potential_roi > 0)
                .sort((a, b) => b.potential_roi - a.potential_roi)
                .slice(0, 10);
            
            displayTop10Results(positiveOpportunities);

        } catch (error) {
            console.error('Error en el proceso de análisis:', error);
            const friendlyError = error.message.includes('Failed to fetch') 
                ? 'No se pudo conectar con el servidor. Revisa la consola.' 
                : error.message;
            loaderText.textContent = `Error: ${friendlyError}`;
            loader.querySelector('.loader').classList.add('hidden'); // Ocultar spinner en error
        } finally {
            // No ocultar el loader si hay un error para que el mensaje sea visible
            if (!loaderText.textContent.startsWith('Error:')) {
                setLoadingState(false);
            }
        }
    }

    // --- API Calls ---
    async function fetchNews() {
        // AHORA: Llama a nuestro propio backend (la función serverless) en lugar de a NewsAPI directamente.
        const response = await fetch('/api/get-news');
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`El servidor backend respondió con un error: ${errorText}`);
        }
        
        const data = await response.json();
        return data.articles;
    }

    async function callGeminiForBulkAnalysis(headlines) {
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const systemPrompt = `Eres un equipo de analistas de Wall Street. Analiza una lista de titulares de noticias financieras para identificar oportunidades de inversión. Para cada titular, identifica el ticker de la acción, determina el sentimiento ('Positivo', 'Negativo', 'Neutral') y estima un rendimiento potencial en un mes (ROI) como un número porcentual. Ignora titulares no relevantes para empresas públicas. Responde únicamente con un array JSON de objetos. Cada objeto debe tener: "ticker" (string), "companyName" (string), "sentiment" (string), y "potential_roi" (number).`;
        
        const payload = {
            systemInstruction: { parts: [{ text: systemPrompt }] },
            contents: [{ parts: [{ text: `Analiza estos titulares:\n${headlines}` }] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate?.content?.parts?.[0]?.text) return JSON.parse(candidate.content.parts[0].text);
        throw new Error("Respuesta inesperada de la API de análisis masivo.");
    }
    
    // --- Data Simulation ---
    function getSimulatedStockPrice(ticker) {
        let hash = 0;
        for (let i = 0; i < ticker.length; i++) {
            hash = ticker.charCodeAt(i) + ((hash << 5) - hash);
        }
        const random_factor = (Math.abs(hash) % 1000) / 1000;
        const price = 50 + random_factor * 450; // Precio entre 50 y 500
        return price.toFixed(2);
    }

    // --- UI Update Functions ---
    function displayTop10Results(opportunities) {
        resultsTbody.innerHTML = '';
        
        if (opportunities.length === 0) {
            resultsTbody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-gray-400">La IA no encontró oportunidades de inversión claras en las noticias de hoy.</td></tr>';
            resultsContainer.classList.remove('hidden');
            return;
        }

        opportunities.forEach(op => {
            const currentPrice = getSimulatedStockPrice(op.ticker);
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-800 hover:bg-gray-800/50';

            row.innerHTML = `
                <td class="p-3 font-bold text-lg">${op.ticker}</td>
                <td class="p-3 text-gray-300">${op.companyName}</td>
                <td class="p-3"><span class="px-2 py-1 rounded-full text-sm font-semibold bg-green-500/20 text-green-300">${op.sentiment}</span></td>
                <td class="p-3 text-right font-mono">$${currentPrice}</td>
                <td class="p-3 text-right font-bold text-green-400">+${op.potential_roi.toFixed(2)}%</td>
            `;
            resultsTbody.appendChild(row);
        });

        resultsContainer.classList.remove('hidden');
    }

    function setLoadingState(isLoading, message = '') {
        loader.querySelector('.loader').classList.remove('hidden');
        loaderText.textContent = message;
        if (isLoading) {
            analyzeButton.disabled = true;
            loader.classList.remove('hidden');
            loader.classList.add('flex');
        } else {
            analyzeButton.disabled = false;
            loader.classList.add('hidden');
            loader.classList.remove('flex');
        }
    }
</script>
</body>
</html>
